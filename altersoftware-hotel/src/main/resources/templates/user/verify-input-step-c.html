<!DOCTYPE html>
<!-- saved from url=(0053)https://getbootstrap.com/docs/4.2/examples/dashboard/ -->
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

	<meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">

	<title>人脸验证</title>

	<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.bootcss.com/paper-css/0.4.1/paper.css" rel="stylesheet">
	<link href="../../static/css/left-side-menu.css" rel="stylesheet" th:href="@{/css/left-side-menu.css}"
	      type="text/css">
	<link href="../../static/fonts/iconfont.css" rel="stylesheet" th:href="@{/fonts/iconfont.css}" type="text/css">
	<link href="../../static/css/head.css" rel="stylesheet" th:href="@{/css/head.css}" type="text/css">
	<script src="../../static/js/jquery.min.js" th:src="@{/js/jquery.min.js}" type="text/javascript"></script>
	<script src="../../static/js/jquery.slimscroll.min.js" th:src="@{/js/jquery.slimscroll.min.js}"
	        type="text/javascript"></script>
	<script src="../../static/js/lib/bootstrap-table.min.js" th:src="@{/js/lib/bootstrap-table.min.js}"
	        type="text/javascript"></script>
	<script src="../../static/js/lib/bootstrap-table-zh-CN.min.js" th:src="@{/js/lib/bootstrap-table-zh-CN.min.js}"
	        type="text/javascript"></script>

	<script src="../../static/js/left-side-menu.js" th:src="@{/js/left-side-menu.js}" type="text/javascript"></script>
	<script src="https://cdn.staticfile.org/popper.js/1.15.0/umd/popper.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script>
	<script src="../../static/js/footposition.js" th:src="@{/js/footposition.js}" type="text/javascript"></script>
	<link rel="shortcut icon" th:href="@{/img/favicon.ico}" type="text/css">

	<link rel="stylesheet" th:href="@{/checkin/demo.css}" type="text/javascript">
	<script th:src="@{/checkin/tracking-min.js}" type="text/javascript"></script>
	<script th:src="@{/checkin/face-min.js}" type="text/javascript"></script>
	<script th:src="@{/checkin/stats.min.js}" type="text/javascript"></script>
	<style>
		video, canvas {
			margin-left: 250px;
			margin-top: 60px;
			position: absolute;
		}
	</style>

</head>

<body>

<nav class="navbar navbar-dark fixed-top bg-dark flex-md-nowrap p-0 shadow">
	<a class="navbar-brand col-sm-3 col-md-2 mr-0" href="/hotel/index">Alter Hotel</a>

	<ul class="navbar-nav " style="left: 82%;position: absolute;">
		<li>
			<a class="nav-link" href="#"><img src="https://www.easyicon.net/api/resizeApi.php?id=1223096&size=128"
			                                  th:src="@{/img/resizeApi3.png}"
			                                  style="filter: invert(100%) sepia(100%) saturate(0%) hue-rotate(179deg) brightness(100%) contrast(103%);width: 12 px;height: 11px;width: 15px;height: 16px;"></a>
		</li>
	</ul>

	<ul class="navbar-nav " style="left: 84.5%;position: absolute;">
		<li>
			<a class="nav-link" href="#"><img src="https://www.easyicon.net/api/resizeApi.php?id=1222625&size=128"
			                                  th:src="@{/img/resizeApi2.png}"
			                                  style="filter: invert(100%) sepia(100%) saturate(0%) hue-rotate(179deg) brightness(100%) contrast(103%);width: 12 px;height: 11px;width: 15px;height: 16px;"></a>
		</li>
	</ul>

	<ul class="navbar-nav " style="left: 87%;position: absolute;">
		<li>
			<a class="nav-link" href="#"><img src="https://www.easyicon.net/api/resizeApi.php?id=1225474&size=128"
			                                  th:src="@{/img/resizeApi1.png}"
			                                  style="filter: invert(100%) sepia(100%) saturate(0%) hue-rotate(179deg) brightness(100%) contrast(103%);width: 12 px;height: 11px;width: 15 px;height: 16px;"></a>
		</li>
	</ul>

	<ul class="navbar-nav " style="left: 90%;position: absolute;">
		<li>
			<a class="nav-link" href="/hotel/user/sign-in">登录&nbsp&nbsp<img
					src="https://www.easyicon.net/api/resizeApi.php?id=1103533&size=128" th:src="@{/img/user.png}"
					style="filter: invert(100%) sepia(100%) saturate(0%) hue-rotate(179deg) brightness(100%) contrast(103%);width: 13 px;height: 13px;">
			</a>
		</li>
	</ul>
</nav>

<main class="col-md-12 ml-sm-auto col-lg-12 px-4" role="main">
	<div class="chartjs-size-monitor"
	     style="position: absolute; left: 0px; top: 0px; right: 0px; bottom: 0px; overflow: hidden; pointer-events: none; visibility: hidden; z-index: -1;">
		<div class="chartjs-size-monitor-expand"
		     style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1;">
			<div style="position:absolute;width:1000000px;height:1000000px;left:0;top:0"></div>
		</div>
		<div class="chartjs-size-monitor-shrink"
		     style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1;">
			<div style="position:absolute;width:200%;height:200%;left:0; top:0"></div>
		</div>
	</div>
	<h2 style="color: rgb(135, 106, 32);font-family: 宋体;">请进行最后一步认证：人脸扫描</h2>
	<br>
	<br>
	<!-- Begin page content -->
	<div class="container">
		<div class="row text-center">
			<div class="col-md-1"></div>
			<div class="col-md-2">
				<img height="36px" th:src="@{/img/user.png}" width="36px">
				<h6>验证身份</h6>
			</div>
			<div class="col-md-2"></div>
			<div class="col-md-2">
				<img height="36px" th:src="@{/img/house.png}" width="36px">
				<h6>办理房间</h6>
			</div>
			<div class="col-md-2"></div>
			<div class="col-md-2">
				<img height="36px" th:src="@{/img/face1.png}" width="36px">
				<h6>人脸扫描</h6>
			</div>
			<div class="col-md-1"></div>
		</div>

		<div class="progress mt-4 mb-4">
			<div aria-valuemax="100" aria-valuemin="0" aria-valuenow="15"
			     class="progress-bar progress-bar-striped bg-warning" role="progressbar" style="width:100%"></div>
		</div>

		<div class="row">
			<div class="col-md-12" style="text-align: center;">
				<h4 style="color: rgb(105, 105, 105);font-family: 宋体;">在最后一个步骤中，您需要进行人脸扫描来获取认证，在这之后，您便可以成功入住</h4>
			</div>
		</div>

		<div class="card" style="margin-top: 50px;margin-bottom:10px;">
			<div class="card-header">
				人脸扫描
			</div>
			<div class="card-body" style="height: 500px">
				<div height="800" id="captures" width="600"></div>
			</div>
			<!--			<div class="row" style="margin-bottom: 10px;">-->

			<!--			</div>-->
			<div class="row" style="margin-top: 1px;margin-bottom:20px ">
				<button class="btn  btn-danger col-md-2 offset-md-5" id="captureBtn">抓取面部资料</button>
			</div>
			<video autoplay height="440" id="video" loop muted preload width="600"></video>
			<canvas height="440" id="canvas" width="600"></canvas>
		</div>
		<div class="card-footer" style="height: 10px;">
		</div>
	</div>

</main>


<footer
		style="background-color: rgb(231, 231, 231);height: 50px;width: 100%;text-align: center;line-height: 50px;position: fixed;bottom: 0;">
	<p style="color:rgb(151, 150, 150) ;font-size: 12px;font-weight: 600;">ALTER SOFTWARE ©2020 1 25</p>

</footer>


<script>
    window.onload = function () {
        var video = document.getElementById('video');
        var canvas = document.getElementById('canvas');
        var context = canvas.getContext('2d');
        //检测类型-人脸
        var tracker = new tracking.ObjectTracker('face');
        //检测级别越大延迟越高
        tracker.setInitialScale(4);
        tracker.setStepSize(1);
        tracker.setEdgesDensity(0.1);
        //camera的视频流在video显示里
        tracking.track('#video', tracker, {camera: true});
        //描出canvas里实时绘制人脸框
        tracker.on('track', function (event) {
            context.clearRect(0, 0, canvas.width, canvas.height);

            event.data.forEach(function (rect) {
                context.strokeStyle = '#ff0000';
                context.strokeRect(rect.x, rect.y, rect.width, rect.height);

                context.font = '14px Helvetica';
                //选框文字颜色
                context.fillStyle = "#ff0000";
                //定义选框旁显示文字
                context.fillText('x: ' + rect.x + 'px', rect.x + rect.width + 5, rect.y + 11);
                context.fillText('y: ' + rect.y + 'px', rect.x + rect.width + 5, rect.y + 22);

            });
        });

        var gui = new dat.GUI();
        gui.add(tracker, 'edgesDensity', 0.1, 0.5).step(0.01);
        gui.add(tracker, 'initialScale', 1.0, 10.0).step(0.1);
        gui.add(tracker, 'stepSize', 1, 5).step(0.1);
    };

    var roomNumber;
    var phone;
    document.getElementById('captureBtn').onclick = function () {
        console.log("获取手机账号");
        // 获取url上的site参数并且传入表单
        var searchParams = new URLSearchParams(window.location.search);
	    phone = searchParams.get('phone');
        console.log("获取房间号");
        // 获取url上的site参数并且传入表单
        var searchParams = new URLSearchParams(window.location.search);
	    roomNumber = searchParams.get('roomNumber');

        // alert("抓取成功");
        //创建canvas
        let canvas = document.createElement('canvas');
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

        // 显示抓图
        let img = document.createElement('img');
        img.src = canvas.toDataURL('image/png');
        document.getElementById('captures').prepend(img);
        // alert(canvas.toDataURL('image/png'));
        var userId = getCookie("userId");
        if (phone != null) {
            userId = null;
        }
        url = "/hotel/checkin/body-check";
        data = {
            base64: canvas.toDataURL('image/png'),
            customerId: userId,
            phone: phone

        };
        parameterPostRequest(url, data);
// 				下载抓图
//            let a = document.createElement('a');
//            let event = new MouseEvent('click');
//            a.download = '下载图片命名'
//            a.href = canvas.toDataURL('image/png');
//            a.dispatchEvent(event)

    };

    function getCookie(objName) {//获取指定名称的cookie的值
        var arrStr = document.cookie.split("; ");
        for (var i = 0; i < arrStr.length; i++) {
            var temp = arrStr[i].split("=");
            if (temp[0] == objName)
                return unescape(temp[1]);
        }
    }

    // 有参数post请求
    function parameterPostRequest(url, data, callback) {
        $.ajax({
            type: "POST",
            url: url,
            dataType: "json",
            data: JSON.stringify(data),
            traditional: true,
            contentType: "application/json",
            success: function (result) {
                if (result.success === false) {
                    switch (result.code) {
                        case 9001:
                            swal("错误", "数据库错误", "error");
                            break;
                        case 9002:
                            alert("对不起,未检测到人脸,请勿使用照片验证");
                            break;
                        case 9005:
                            swal("错误", "文件删除错误", "error");
                            break;
                        case 9006:
                            swal("错误", "文件创建错误", "error");
                            break;
                        case 9007:
                            swal("错误", "文件不存在", "error");
                            break;
                        case 9999:
                            alert("对不起,人像不清晰,请尝试摘下眼镜或背对光源后重试");
                            break;
                    }
                } else {
                    console.log(result);
                    var order = result.module;
                    $.ajax({
                        url: "/hotel/record/checkin",
                        type: "POST",
                        contentType: "application/x-www-form-urlencoded",
                        data: {
                            "roomNumber": roomNumber,
                        },
                        success: function (result) {
                            console.log(result);
                            alert("成功");
                            if(phone==null){
                                window.location.href = "/hotel/checkin/step_success";
                            }else {
                                window.location.href = "/hotel/checkin/step_success?phone="+phone;
                            }
                            // callback(result);
                        }
                    });
                }
            },
            error: function () {
                swal("错误", "404", "error");
            }
        });
    }


</script>


</body>

</html>